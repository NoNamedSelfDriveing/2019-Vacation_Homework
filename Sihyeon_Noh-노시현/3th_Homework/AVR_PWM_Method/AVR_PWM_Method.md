# PWM Method

AVR에서는 timer/counter를 이용하여 PWM을 이용할 수 있다.

Atmega128a는 8비트와 16비트 크게 두 가지 종류의 타이머/카운터를 가진다.



### Timer/Counter

- Timer : MCU 내부 클럭을 세는 장치
  - 동기모드
  - 타이머는 MCU의 내부 클럭을 세어 일정시간 간격의 펄스를 만들어내거나 일정시간 경과 후에 인터럽트를 발생
  - 내부클럭(빠름/분주 가능)
- Counter : MCU의 외부에서 입력되는 클럭을 세는 장치
  - 비동기모드
  - 카운터는 외부 핀(TOSC1, TOSC2, T1, T2, T3)을 통해서 들어오는 펄스를 계수(Edge Detector)하여 Event Counter로서 동작
  - 외부클럭(느림/분주 불가능)



## Atmega128a의 타이머 카운터

- 타이머 0~3 모두 4개의 타이머/카운터를 보유
  - 타이머 0, 2 (8비트)
  - 타이머 1, 3 (16비트)
- 인터럽트 기능 
  - 오버플로우 인터럽트 : 카운터의 값이 오버플로우되는 경우 발생
  - 출력비교 인터럽트 : 카운터 값이 출력비교 레지스터의 값과 같게 되는 순간에 발생
  - 입력 캡쳐 인터럽트 : 외부로부터의 트리거 신호에 의해서 카운터의 초기값을 입력캡쳐
- PWM 출력 기능

### 8비트 타이머/카운터의 특징

- 4개의 타이머/카운터 중 0번과 2번 타이머/카운터

- PWM 및 비동기 동작 모드를 갖는 8비트 업/다운 카운터

- 8비트의 카운터 보유 (2의8승 = 256, 즉 0 ~ 255까지 셀 수 있음)

- 10비트의 프리스케일러 보유

- 각종 인터럽트 기능

  - 오버플로우 인터럽트(Overflow interrupt)
  - 출력비교 인터럽트(Output Compare Match Interrupt)

- PWM 기능 제공

- 타이머 0은 부가적으로 32.68KHz의 수정 진동자를 TOS1, 2단자에 연결해 Real Time Clock으로 사용할 수 있는 기능 제공 (타이머 2와 다른 점)

- 관련 레지스터

  - 제어 레지스터(TCCRn)
  - 타이머/카운터 레지스터(TCNTn)
  - 출력 비교 레지스터(OCRn)
  - 인터럽트 관련
    - 타이머/카운터 인터럽트 플래그 레지스터(TIFR)
    - 타이머/카운터 인터럽트 마스크 레지스터 (TIMSK)

- 프리스케일러

  - 고속의 클럭을 사용하여 타이머를 동작시킬 때 나타나는 문제를 해결하기 위해 클럭을 분주하여 더 느린 타이머 클럭을 만든다.
  - 10비트 프리스케일러 보유 (최대 1024배)
  - 타이머 0
    - 클럭소스 : TOSC1에 입력된 시스템 클럭 주파수의 1/4미만의 외부 클럭, TOSC1/TOSC2단자에 연결된 수정 진동자에 의해 발생된 클럭, 내부 클럭
    - 분주비 : 1, 8, 32 ,64, 128, 256, 1024
  - 타이머 2
    - 클럭소스 : T2핀으로 입력되는 외부 클럭, 내부 클럭
    - 분주비 : 1, 8 ,64, 256, 1024

- 동작모드

  타이머/카운터 0과 2는 4가지의 동작모드를 가진다.

  타이머/카운터 1과 3에는 PFCPWM 모드가 추가되어 총 5가지이다.

1. Normal Mode(일반 동작 모드)

   - 가장 간단한 카운터로써 계수 증가는 BOTTOM -> MAX순으로 단순하게 증가하는 업 카운터로만 동작된다.
   - 카운터 도중 타이머/카운터 값이 클리어되지 않는다.
   - 인터럽트는 TCNT값이 MAX->BOTTOM이 될 때 인터럽트가 발생한다. (오버플로우 인터럽트)
   - 외부 펄스 입력을 세는 단순한 카운터 용도로 적합하게 쓰이게 된다.

   

2. CTC(Clear Timer on Compare match) Mode

   - 원하는 시간 간격으로 주기적인 인터럽트를 발생시키는데 적합하다.
   - 카운터 BOTTOM에서 설정된 OCR 값과 같아지면 0으로 클리어되면서 인터럽트가 발생한다.

   - 0x00 ~ OCR0 계수 동작을 반복한다.
   - 비교 매치 (COMP) 인터럽트
   - 주의점 : OCR레지스터는 이중 버퍼링 기능이 없기 때문에 타이머가 동작 중일 때 OCR값을 바꾸면 문제가 생길 수 있음

3. Fast PWM Mode

   - 고속으로 PWM 파형을 발생시키는데 적합하다.
   - 계수는 BOTTOM->MAX순으로 단순하게 증가하는 방향으로만 반복 수행하는 단방향 경사 동작이다.
   - TCCRn레지스터의 COM 비트 설정에 따라 비반전 비교 출력모드와 비교 출력 모드 기능을 가진다. 비반전 출력 모드와 반전 출력 모드는 반대로 토글되어 출력된다.
   - TCNT0과 OCR0의 Compare Match되면 OC0에 LOW출력하고, 이후에 0xFF -> 0x00 오버플로우되면 OC0에 HIGH 출력

4. PCPWM(Phase Correct Pulse Width Modulation) Mode

   - 높은 분해능의 PWM출력 파형을 발생하는데 유용하다.
   - 주파수를 절반으로 희생시키는 대신에 분해능이 2배인 16비트로 높아진다.
   - 계수는 BOTTOM->MAX->BOTTOM순이고, 업 카운터, 다운 카운터의 기능을 동시에 가지는 양방향 경사 동작이다.
   - 주기가 동일하며, OC와 /OC는 서로 반대로 토들되어 출력된다.
   - TCNT값은 BOTTOM -> MAX -> BOTTOM 순으로 감소 -> 증가 -> 감소되는데 감소 -> 증가 과정에서 TCNT값이 OCR값과 비교하여 같아지면 OC = 0으로 클리어되고 증가 -> 감소 과정에서 TCNT값이 OCR값과 비교하여 같아지면 OC는 1로 세트된다.
   - 양방향 PWM을 대칭적으로 가지면 높은 분해능을 가지기 때문에 모터 제어에 적합하다.

- 8비트 타이머/카운터의 동작
  - 동작모드 결정
  - 타이머에 사용할 클럭 소스와 프리스케일러 결정
  - 원하는 타이머의 주기 및 그 주기 동안의 시간을 정확히 세기 위한 타이머 클럭의 수 결정
  - 카운터 레지스터의 카운터 시작 값 설정

### 관련 용어

- BOTTOM : 카운터가 가질 수 있는 최솟값을 말한다.
- MAX : 카운터가 가질 수 있는 최대값을 말한다.
- TOP : 각 동작 모드에 따라 카운터가 실제로 도달하는 최댓값을 나타낸다. (혹은 비교일치 레지스터 OCR의 설정값)
- COUNT : TCNT0의 1씩 증가 또는 감소하는 것
- DIRECTION : COUNT의 증감/감소 설정
- CLEAR : Clear TCNTO
- CLKTO : 타이머/카운터 클럭

### 관련 레지스터

- TCCRn(Timer/Counter Control Register n)

  - 타이머/카운터 제어에 관련된 설정을 하는 레지스터 n(n=0 or 2)

  - 동작 모드, 프리스케일러 등 타이머/카운터의 전반적인 동작 형태을 결정

  - Bit 7 - FOCn (Force Output Compare) 강제 출력 비교

    - PWM 모드가 아닌 경우에만 유효하며, 이 비트를 세트하면 즉시 강제로 OC단자에 출력 비교가 일치된 것과 동일한 출력을 내보낸다. 그러나 인터럽트를 발생하지 않으며, TCNT레지스터를 클리어하지도 않기 때문에 특별한 경우가 아니면 0으로 설정한다.

  - Bit 6, 3 - WGM(Waveform Generation Mode) 파형 발생 모드

    - 타이머/카운터의 동작모드 설정

    - 카운터의 카운팅 방향, 최대 카운터 값, Waveform Generation 방식 등을 결정

      | Mode | WGMn1 | WGMn0 | T/C Mode of Operation | TOP  |
      | :--: | :---: | :---: | :-------------------: | :--: |
      |  1   |   0   |   0   |       일반 모드       | 0xFF |
      |  2   |   0   |   1   |      PC PWM 모드      | 0xFF |
      |  3   |   1   |   0   |       CTC 모드        | OCRn |
      |  4   |   1   |   1   |     고속 PWM 모드     | 0xFF |

    

  - Bit 5, 4 - COM(Compare Output Mode) 비교 일치 출력 모드

    - OCn핀의 동작을 결정
    - 타이머/카운터 동작 모드에 따라 달라진다.
    - OC핀으로 출력을 원하는 경우, 해당 포트의 데이터 출력 방향을 DDRx에서 출력으로 해놓아야 한다.

  - Bit 2, 1, 0 - CSn(Clock Select) 클럭 선택

    - 타이머/카운터에 사용할 클럭과 프리스케일러를 선택

- TCNTn(Timer/Counter Register n)

  - 타이머/카운터 레지스터 n (n은 0 or 2)

  - 타이머/카운터 n의 8비트 카운터 값을 저장하고 있는 레지스터

  - 이 레지스터는 쓸 수도 있고 읽을 수도 있다. 하지만 동작 중에 수정하게 되면 사용자의 의도와 다르게 TCNT값과 OCR값을 비교하여 출력 신호를 발생할 수 있으니 주의해야한다.

  - 임의의 값을 써주면 타이머의 주기를 더 빠르게 할 수 있다.

  - 레지스터의 값은 인터럽트가 걸리면 자동으로 0으로 클리어되고, 다시 분주된 주기마다 한 개씩 값이 늘어난다.

- OCRn(Output Compare Resister)

  - 출력 비교 레지스터 n(n은 0 or 2)

  - 타이머/카운터 레지스터 TCNT값과 비교하여 OCn단자에 출력을 발생하기 위한 8비트 값을 저장하는 레지스터
  - OCR 레지스터는 이중 버퍼 구조로 되어있어서 사용자가 동작 도중에 값을 수정하더라도 바로 바뀌지않고 TOP혹은BOTTOM에 도달했을 때 바뀌게 된다. 때문에 글리치 (노이즈 신호)가 발생하지 않는 것이다.
    - PWM모드가 아니라 일반 CTC모드에서는 이중 버퍼링 구조로 동작하지 않기 때문에 글리치가 발생할 수도 있으니 주의해야 한다.

- TIMSK (Timer Interrupt Mask)

  - 타이머 인터럽트 마스크 레지스터
  - 타이머/카운터0 ~ 2가 발생하는 인터럽트를 개별적으로 허용하는 기능을 수행하는 레지스터
  - Bit 1, 7 - OCIE0,OCIE2
    - 타이머 카운터0/2의 출력비교 인터럽트 허용
  - Bit 0, 6 - TOIE0/TOIE2
    - 타이머/카운터0/2의 오버플로우 인터럽트 허용

- TIFR (Timer Interrupt Flag Register)

  - 타이머/카운터0 ~ 2가 발생하는 인터럽트 플래그가 저장되는 레지스터

  - Bit 7 - OCF2 (타이머/카운터 2 출력 비교 플래그 비트)
    - 타이머/카운터 2에서 TCNT2와 OCR2값이 같아지면 OCF2 = 1로 세트되면서 인터럽트를 요청하고 인터럽트가 처리되기 시작할 때 하드웨어에 의해 자동으로 OCF2 = 0으로 클리어된다.
  - Bit 6 - TOV2(타이머/카운터 2 오버 플로우 플래그 비트)
    - 타이머/카운터 2에서 오버플로우가 발생하면 TOV2 = 1로 세트되면서 인터럽트를 요청하고 인터럽트가 처리되기 시작할 때 하드웨어에 의해 자동으로 TOV2 = 0으로 클리어된다.
  - Bit 1 - OCF0 (타이머 카운터 0 출력 비교 플래그 비트)
    - 타이머/카운터 0에서 TCNT0과 OCR0 값이 같아지면 OCF0 = 1로 세트되면서 인터럽트를 요청하고 인터럽트가 처리되기 시작할 때 하드웨어에 의해 자동으로 OCF0 = 0으로 클리어된다.
  - Bit 0 - TOV0 (타이머/카운터 0 오버 플로우 플래그 비트)
    - 타이머/카운터 0에서 오버플로우가 발생하면 TOV0 = 1로 세트되면서 인터럽트를 요청하고 인터럽트가 처리되기 시작할 때 하드웨어에 의해 자동으로 TOV0 = 0으로 클리어된다.

- ASSR(ASynchronous Status Register)

  - 타이머/카운터 0에만 해당되는 레지스터로써, 외부 클럭에 의하여 비동기 모드로 시작하는 경우에 관련된 기능을 수행한다.

  - Bit 7 ~ 4 - 사용되지 않음(Reserved)

  - Bit 3 - AS0(ASynchronous Timer/Counter)
    - 타이머/카운터 0의 클럭 소스를 선택하는 비트
    - AS = 0 : 내부 클럭 clk I/O가 선택되어 동기적으로 동작
    - AS = 1 : 외부클럭 TOSC1이 선택되어 비동기적으로 동작
  - Bit 2 - TCNOUB(Timer/CouNTer0 Update Busy)
    - 타이머/카운터 0이 비동기적으로 동작하고 있는 경우 TCNT0에 새로운 값이 써질 때 TCN0UB = 1로 세트되며 쓰기가 완료되면 TCN0UB = 0으로 클리어 된다.

  - Bit 1 - OCROUB(Output Compare Register 0 Update Busy)
    - 타이머/카운터 0이 비동기적으로 동작하고 있는 경우 OCR0에 새로운 값이 써질 때 OCR0UB = 1로 세트되며 쓰기가 완료되면 OCR0UB = 0으로 클리어 된다.
  - Bit 0 - TCROUB(Timer Counter Register 0 Update Busy)
    - 타이머/카운터 0이 비동기적으로 동작하고 있는 경우 TCCR0에 새로운 값이 써질 때 TCR0UB = 1로 세트되면 쓰기가 완료되면 TCR0UB = 0으로 클리어된다.

- SFIOR(Special Funtion I/O Reister)

  - 특수 기능 I/O 레지스터
  - 타이머/카운터들을 동기화 하는데 관련된 기능을 담당하는 레지스터
  - Bit 7 - TSM(Timer Synchronization Mode)
    - '0' : PSR0, PSR321비트를 하드웨어적으로 클리어
    - 이로 인해, 타이머들이 동시에 카운팅 동작을 시작한다.
  - Bit 1 - PSR0(Prescaler Reset Timer 0)
    - '1' : 타이머 0의 프리스케일러를 리셋
  - Bit 0 - PSR321(Prescaler Reset Timer 321)
    - '1' : 타이머 1/2/3의 프리스케일러를 리셋

### 인터럽트 벡터

인터럽트가 발생했을 때, 그 인터럽트를 처리할 수 있는 서비스 루틴들의 주소를 가지고 있는 공간



### 펄스(Pulse)와 펄스폭(Pulse Width)

- 펄스 : 짧은 시간동안 생기는 진동 현상
- 펄스 폭 : 하나의 펄스가 가지는 폭